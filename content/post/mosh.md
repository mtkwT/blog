---
title: "CentOS7にMoshをインストールして快適なリモート接続ライフを送る"
date: 2020-04-12T00:40:58+09:00
draft: False
tags: ["ssh", "shell"]
---
## Mosh（Mobile shell）とは
Moshは不安定な回線環境でも堅牢なリモート接続を行ってくれるリモートターミナルアプリケーションです。
初リリースは2012年3月12日と8年前に出たアプリケーションです。  
https://mosh.org

## しくみ
サーバ側にMoshサーバがインストールされている状態でローカルのPCから
```
mosh (username)@(hostname)
```
と打つと、サーバに対して素のSSH接続を行います。
SSHのリモートコマンド実行によってリモートサーバ側でMoshサーバを立ち上げます。
そして立ち上がったMoshサーバとローカルのMoshクライアントがUDPで接続を行うというような仕組みになっています。
サーバ側で起動した仮想端末にこちらのクライアントが接続しにいくという構図なのでtmuxなどと近いしくみです。

## 利点
素のSSHはTCP接続ですが、MoshではUDPで接続されるのでパケットロスなどに強いです。
また、デフォルトで再接続を行うので途中でWifiを変えたりVPNが切れても、もう一度繋げば自動で再接続が行われます。
さらにMoshでは劣悪な回線利用者のためにローカルのエコーバックがあり、キーボード入力が端末側へ即座に反映されます。
普段マンションの劣悪な無料回線を使用している私にとってはこの利点がとても大きいです。
- リモート接続が自動で復活する
- ローカルのエコーバックが良い

## Mosh導入方法
### 環境
- サーバ: CentOS7
- ローカル: macOS Catalina 10.15.2 

大前提としてローカルからサーバに対して素のSSH接続できる必要があります。
### サーバ側
Moshサーバをyumからインストールします。
デフォルトではyumリポジトリの中にmoshが存在しないので、まずEPELリポジトリのインストールが必要です。
```
sudo yum install epel-release
```
mosh本体をインストールします。
```
sudo yum install mosh
```
これでサーバ側は完了です。
### ローカル側
今回はmacを想定しているので、brewでmoshクライアントをインストールします。
```
brew install mobile-shell
```
これで終わりです。簡単ですね。

## Moshの実行
普通のSSHと同様に以下のコマンドで接続できます。
```
mosh (username)@(hostname)
```

```
Host 任意の接続名(hoge)
HostName ホスト名
User ユーザー名
IdentityFile 秘密鍵へのPATH
```
上記のような~/.ssh/configを設定している場合、以下のコマンドで接続できます。
```
mosh hoge
```
